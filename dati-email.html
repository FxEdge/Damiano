<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dati Email ‚Äì Dashboard</title>
  <link rel="icon" href="assets/logo.svg">
  <style>
    :root{--bg:#f3f4f6;--surface:#fff;--text:#111827;--muted:#6b7280;--border:#e5e7eb;--primary:#2563eb}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
    .container{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-bottom:16px}
    h1{margin:0 0 12px}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input[type="text"], textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;font:inherit;background:#fff}
    textarea{min-height:170px;resize:vertical;white-space:pre-wrap}
    .row{display:flex;gap:12px;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,#2563eb,#2f5ef6);color:#fff;border:none}
    .muted{color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .hidden{display:none}
    .list {
  margin-top: 10px;
  border: 1px solid var(--border);
  border-radius: 10px;
  max-height: 260px;
  overflow: auto;
  background: #fff;
  padding: 10px;   /* üîπ questo √® l‚Äôaggiunta */
}
    .item{padding:10px;border-bottom:1px solid var(--border);cursor:pointer}
    .item:hover{background:#f7f7fb}
    .item { position: relative; }
.item .item-del {
  position: absolute;
  right: 10px;
  top: 10px;
  cursor: pointer;
  opacity: .7;
}
.item .item-del:hover {
  opacity: 1;
}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;margin-left:6px}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  </style>
</head>
<body>
  <div class="container">
    <h1>üìß Dati Email</h1>
    <p class="muted">Gestisci oggetto e corpo standard delle comunicazioni. I valori qui sotto sono <b>attivi</b> e verranno usati dal sistema.</p>

    <!-- Oggetto -->
    <div class="card" id="card-subject">
      <label for="subject">Oggetto della mail</label>
      <div class="row">
        <input id="subject" type="text" disabled />
        <button class="btn btn-primary" id="btn-change-subject">Cambia</button>
        <button class="btn" id="btn-trash-subject">üóëÔ∏è Cestino</button>
      </div>

      <!-- Step 1 -->
      <div class="actions hidden" id="subject-ask1">
        <span>Vuoi richiamare un testo gi√† inserito?</span>
       <button class="btn" id="subject-yes">SI</button> 
       <button class="btn" id="subject-no">NO</button>
       <button class="btn" id="btn-trash-body">üóëÔ∏è Cestino</button>
      </div>

      <!-- Lista modelli -->
      <div class="list hidden" id="subject-list"></div>

      <!-- Usa questo testo? (dopo scelta dalla lista) -->
      <div class="actions hidden" id="subject-use-ask">
        <span>Vuoi usare questo testo per le mail?</span>
        <button class="btn" id="subject-use-yes">SI</button>
        <button class="btn" id="subject-use-no">NO</button>
      </div>

      <!-- Step 2 -->
      <div class="actions hidden" id="subject-ask2">
        <span>Vuoi modificare questo testo?</span>
        <button class="btn" data-edit="#subject">SI</button>
        <button class="btn" data-cancel>NO</button>
      </div>

      <!-- Salvataggio -->
      <div class="actions hidden" id="subject-save-ask">
        <span>Vuoi salvare questo testo?</span>
        <button class="btn" data-save="subject">SI</button>
        <button class="btn" data-nosave="subject">NO</button>
      </div>

      <!-- Nome modello -->
      <div class="row hidden" id="subject-save-name">
        <input type="text" placeholder="Nome modello (es. Damiano1)" id="subject-model-name">
        <button class="btn btn-primary" id="subject-confirm">Confermi</button>
      </div>
    </div>

    <!-- Corpo -->
    <div class="card" id="card-body">
      <label for="body">Corpo del messaggio</label>
      <div class="row">
        <textarea id="body" disabled></textarea>
        <button class="btn btn-primary" id="btn-change-body">Cambia</button>
      </div>

      <div class="actions hidden" id="body-ask1">
        <span>Vuoi richiamare un testo gi√† inserito?</span>
       <button class="btn" id="body-yes">SI</button>     
       <button class="btn" id="body-no">NO</button>
      </div>

      <div class="list hidden" id="body-list"></div>

      <div class="actions hidden" id="body-use-ask">
        <span>Vuoi usare questo testo per le mail?</span>
        <button class="btn" id="body-use-yes">SI</button>
        <button class="btn" id="body-use-no">NO</button>
      </div>

      <div class="actions hidden" id="body-ask2">
        <span>Vuoi modificare questo testo?</span>
        <button class="btn" data-edit="#body">SI</button>
        <button class="btn" data-cancel>NO</button>
      </div>

      <div class="actions hidden" id="body-save-ask">
        <span>Vuoi salvare questo testo?</span>
        <button class="btn" data-save="body">SI</button>
        <button class="btn" data-nosave="body">NO</button>
      </div>

      <div class="row hidden" id="body-save-name">
        <input type="text" placeholder="Nome modello (es. Damiano1)" id="body-model-name">
        <button class="btn btn-primary" id="body-confirm">Confermi</button>
      </div>
    </div>

    <div class="footer">
      <a class="btn" href="/home.html">‚Üê Torna alla Dashboard</a>
      <span class="muted" id="api-used"></span>
    </div>
  </div>

  <script>
    const API_BASE = localStorage.getItem('API_BASE') || 'https://damiano-backend-ancz.onrender.com';
    document.getElementById('api-used').textContent = `API: ${API_BASE}`;

    const q = sel => document.querySelector(sel);
    const show = el => (typeof el === 'string' ? q(el) : el).classList.remove('hidden');
    const hide = el => (typeof el === 'string' ? q(el) : el).classList.add('hidden');

    // Valori iniziali all'apertura
    let initialSubject = '';
    let initialBody = '';
    // Temporanei scelti dalla lista
    let pickedSubject = { id: null, content: '' };
    let pickedBody = { id: null, content: '' };

    // Carica ATTIVI
    async function loadSettings(){
      const res = await fetch(`${API_BASE}/api/email/settings`);
      const data = await res.json();
      q('#subject').value = initialSubject = data.subject || '';
      q('#body').value    = initialBody    = data.body || '';
    }

    // Lista modelli (CON LOG + header conteggio)
async function loadTemplates(type, containerSel){
  const url = `${API_BASE}/api/email/templates?type=${type}`;
  console.log('[API] GET', url);                    // üëà LOG
  let list = [];
  try{
    const res = await fetch(url);
    list = await res.json();
  }catch(e){
    console.error('[API] Errore fetch templates', e);
  }
  console.log('[API] Templates ricevuti:', type, list); // üëà LOG

  const box = q(containerSel);
  box.innerHTML = '';  // pulisci

  // header conteggio
  const header = document.createElement('div');
  header.className = 'muted';
  header.style.marginBottom = '8px';
  header.textContent = `Modelli trovati: ${list.length}`;
  box.appendChild(header);

  if(!list.length){
    const empty = document.createElement('div');
    empty.className = 'item muted';
    empty.textContent = 'Nessun modello salvato';
    box.appendChild(empty);
    return;
  }

list.forEach(t=>{
  const div = document.createElement('div');
  div.className = 'item';
  div.innerHTML = `
    <b>${t.name}</b>
    <div class="muted" style="margin-top:4px">${(t.content||'').slice(0,160)}</div>
    <span class="item-del" title="Elimina">üóëÔ∏è</span>
  `;

  // CLICK singolo ‚Üí flusso attuale: chiedi ‚ÄúUsare questo testo?‚Äù
  div.onclick = (e) => {
    if (e.target.closest('.item-del')) return; // non interferire col cestino
    if(type==='subject'){
      pickedSubject = { id: t.id, content: t.content, name: t.name };
      show('#subject-use-ask');
    } else {
      pickedBody = { id: t.id, content: t.content, name: t.name };
      show('#body-use-ask');
    }
  };

  // DOPPIO CLICK ‚Üí inserisci subito il testo e vai a ‚ÄúVuoi modificare questo testo?‚Äù
  div.ondblclick = (e) => {
    if (e.target.closest('.item-del')) return;
    if (type === 'subject') {
      q('#subject').value = t.content;           // metti il testo
      hide('#subject-list');                     // chiudi lista
      hide('#subject-use-ask');                  // non serve il passo ‚ÄúUsare?‚Äù
      show('#subject-ask2');                     // chiedi direttamente se vuoi modificare
    } else {
      q('#body').value = t.content;
      hide('#body-list');
      hide('#body-use-ask');
      show('#body-ask2');
    }
  };

  // Cestino (vedi punto 2 sotto)
  div.querySelector('.item-del').onclick = async (e) => {
    e.stopPropagation();
    if (!confirm(`Eliminare il modello "${t.name}"?`)) return;
    try {
      await fetch(`${API_BASE}/api/email/templates/${t.id}?type=${type}`, { method: 'DELETE' });
      // ricarica lista
      loadTemplates(type, containerSel);
    } catch(err){
      alert('Errore durante l‚Äôeliminazione');
    }
  };
  // CESTINO (Oggetto)
q('#btn-trash-subject').onclick = () => {
  deletionMode = 'subject';
  hide('#subject-ask1'); hide('#subject-ask2'); hide('#subject-use-ask');
  hide('#subject-save-ask'); hide('#subject-save-name');
  loadTemplates('subject', '#subject-list', { deletion: true });
  show('#subject-list');
};

q('#btn-trash-body').onclick = () => {
  deletionMode = 'body';
  hide('#body-ask1'); hide('#body-ask2'); hide('#body-use-ask');
  hide('#body-save-ask'); hide('#body-save-name');
  loadTemplates('body', '#body-list', { deletion: true });
  show('#body-list');
};

  box.appendChild(div);
});
}
    // Salva ATTIVI
    async function saveSettings(payload){
      await fetch(`${API_BASE}/api/email/settings`, {
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
    }

    // Salva modello
    async function saveTemplate(type, name, content){
      const res = await fetch(`${API_BASE}/api/email/templates`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({type, name, content})
      });
      return res.json();
    }

  document.addEventListener('DOMContentLoaded', () => {

  /* ===== SUBJECT ===== */
  q('#btn-change-subject').onclick = () => {
    hide('#subject-ask2'); hide('#subject-list'); hide('#subject-save-ask'); hide('#subject-save-name'); hide('#subject-use-ask');
    show('#subject-ask1');
  };

  // SI ‚Üí lista diretta
  q('#subject-yes').onclick = () => {
    console.log('[UI] Click su SI (subject)');
    hide('#subject-ask1');
    loadTemplates('subject', '#subject-list');
    show('#subject-list');
  };

  // NO ‚Üí domanda ‚ÄúVuoi modificare questo testo?‚Äù
  q('#subject-no').onclick = () => {
    console.log('[UI] Click su NO (subject)');
    hide('#subject-ask1');
    show('#subject-ask2');
  };

  // Dopo scelta lista: "Usare questo testo?"
  q('#subject-use-yes').onclick = async () => {
    q('#subject').value = pickedSubject.content;
    await saveSettings({ subject: pickedSubject.content, subject_template_id: pickedSubject.id });
    hide('#subject-use-ask'); hide('#subject-list');
    alert('Impostato come testo attivo.');
  };
  q('#subject-use-no').onclick = () => { hide('#subject-use-ask'); show('#subject-ask2'); };

  q('#subject-ask2 [data-edit]').onclick = () => {
    q('#subject').disabled = false;
    hide('#subject-ask2');
    show('#subject-save-ask');
  };

  q('[data-save="subject"]').onclick = () => { hide('#subject-save-ask'); show('#subject-save-name'); };
  q('[data-nosave="subject"]').onclick = async () => {
    q('#subject').value   = initialSubject;
    q('#subject').disabled = true;
    await saveSettings({ subject: initialSubject, subject_template_id: null });
    hide('#subject-save-ask'); hide('#subject-ask2');
  };

  q('#subject-confirm').onclick = async () => {
    const name = q('#subject-model-name').value.trim();
    if(!name) return alert('Inserisci un nome');
    const content = q('#subject').value;
    const t = await saveTemplate('subject', name, content);
    await saveSettings({ subject: content, subject_template_id: t.id });
    q('#subject').disabled = true; hide('#subject-save-name');
    alert('Salvato e impostato come attivo.');
  };

  /* ===== BODY (opzionale ora, ma coerente) ===== */
  q('#btn-change-body').onclick = () => {
    hide('#body-ask2'); hide('#body-list'); hide('#body-save-ask'); hide('#body-save-name'); hide('#body-use-ask');
    show('#body-ask1');
  };

  q('#body-yes').onclick = () => {
    console.log('[UI] Click su SI (body)');
    hide('#body-ask1');
    loadTemplates('body', '#body-list');
    show('#body-list');
  };

  q('#body-no').onclick = () => {
    console.log('[UI] Click su NO (body)');
    hide('#body-ask1');
    show('#body-ask2');
  };

  q('#body-use-yes').onclick = async () => {
    q('#body').value = pickedBody.content;
    await saveSettings({ body: pickedBody.content, body_template_id: pickedBody.id });
    hide('#body-use-ask'); hide('#body-list');
    alert('Impostato come testo attivo.');
  };
  q('#body-use-no').onclick = () => { hide('#body-use-ask'); show('#body-ask2'); };

  q('#body-ask2 [data-edit]').onclick = () => {
    q('#body').disabled = false;
    hide('#body-ask2');
    show('#body-save-ask');
  };

  q('[data-save="body"]').onclick = () => { hide('#body-save-ask'); show('#body-save-name'); };
  q('[data-nosave="body"]').onclick = async () => {
    q('#body').value    = initialBody;
    q('#body').disabled = true;
    await saveSettings({ body: initialBody, body_template_id: null });
    hide('#body-save-ask'); hide('#body-ask2');
  };

  q('#body-confirm').onclick = async () => {
    const name = q('#body-model-name').value.trim();
    if(!name) return alert('Inserisci un nome');
    const content = q('#body').value;
    const t = await saveTemplate('body', name, content);
    await saveSettings({ body: content, body_template_id: t.id });
    q('#body').disabled = true; hide('#body-save-name');
    alert('Salvato e impostato come attivo.');
  };

  // NO generici (annulla e ripristina)
  document.querySelectorAll('[data-cancel]').forEach(btn=>{
    btn.onclick = () => {
      ['#subject-ask1','#subject-ask2','#subject-list','#subject-use-ask','#subject-save-ask','#subject-save-name',
       '#body-ask1','#body-ask2','#body-list','#body-use-ask','#body-save-ask','#body-save-name'
      ].forEach(hide);
      q('#subject').value = initialSubject;
      q('#body').value = initialBody;
      q('#subject').disabled = true;
      q('#body').disabled = true;
    };
  });

}); // ‚Üê fine DOMContentLoaded


    loadSettings();
  </script>
</body>
</html>

