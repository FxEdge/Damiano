<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dati Email ‚Äì Dashboard</title>
  <link rel="icon" href="assets/logo.svg">
  <style>
    :root{--bg:#f3f4f6;--surface:#fff;--text:#111827;--muted:#6b7280;--border:#e5e7eb;--primary:#2563eb}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
    .container{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-bottom:16px}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input[type="text"], textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;font:inherit}
    textarea{min-height:170px;resize:vertical;white-space:pre-wrap}
    .row{display:flex;gap:12px;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .btn-primary{background:linear-gradient(90deg,#2563eb,#2f5ef6);color:#fff;border:none}
    .muted{color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .hidden{display:none}
    .list{margin-top:10px;border:1px solid var(--border);border-radius:10px;max-height:220px;overflow:auto}
    .item{padding:10px;border-bottom:1px solid var(--border);cursor:pointer}
    .item:hover{background:#f7f7fb}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;margin-left:6px}
  </style>
</head>
<body>
  <div class="container">
    <h1>üìß Dati Email</h1>
    <p class="muted">Gestisci oggetto e corpo standard delle comunicazioni. I valori qui sotto sono <b>attivi</b> e verranno usati dal sistema.</p>

    <!-- Oggetto -->
    <div class="card" id="card-subject">
      <label for="subject">Oggetto della mail</label>
      <div class="row">
        <input id="subject" type="text" disabled />
        <button class="btn btn-primary" id="btn-change-subject">Cambia</button>
      </div>
     <div class="list hidden" id="subject-list"></div>
      <div class="actions hidden" id="subject-ask2">
        <span>Vuoi modificare questo testo?</span>
        <button class="btn" data-edit="#subject">SI</button>
        <button class="btn" data-cancel>NO</button>
      </div>
    
      <div class="actions hidden" id="subject-ask1">
        <span>Vuoi richiamare un testo gi√† inserito?</span>
        <button class="btn" data-yes="#subject-list" data-no="#subject-ask2">SI</button>
        <button class="btn" data-cancel>NO</button>
      </div>
     
      <div class="actions hidden" id="subject-save-ask">
        <span>Vuoi salvare questo testo?</span>
        <button class="btn" data-save="subject">SI</button>
        <button class="btn" data-nosave="subject">NO</button>
      </div>
      <div class="row hidden" id="subject-save-name">
        <input type="text" placeholder="Nome modello (es. Damiano1)" id="subject-model-name">
        <button class="btn btn-primary" id="subject-confirm">Confermi</button>
      </div>
    </div>

    <!-- Corpo -->
    <div class="card" id="card-body">
      <label for="body">Corpo del messaggio</label>
      <div class="row">
        <textarea id="body" disabled></textarea>
        <button class="btn btn-primary" id="btn-change-body">Cambia</button>
      </div>
      <div class="actions hidden" id="body-ask1">
        <span>Vuoi richiamare un testo gi√† inserito?</span>
        <button class="btn" data-yes="#body-list" data-no="#body-ask2">SI</button>
        <button class="btn" data-cancel>NO</button>
      </div>
      <div class="list hidden" id="body-list"></div>
      <div class="actions hidden" id="body-ask2">
        <span>Vuoi modificare questo testo?</span>
        <button class="btn" data-edit="#body">SI</button>
        <button class="btn" data-cancel>NO</button>
      </div>
      <div class="actions hidden" id="body-save-ask">
        <span>Vuoi salvare questo testo?</span>
        <button class="btn" data-save="body">SI</button>
        <button class="btn" data-nosave="body">NO</button>
      </div>
      <div class="row hidden" id="body-save-name">
        <input type="text" placeholder="Nome modello (es. Damiano1)" id="body-model-name">
        <button class="btn btn-primary" id="body-confirm">Confermi</button>
      </div>
    </div>

    <div class="actions">
      <a class="btn" href="/home.html">‚Üê Torna alla Dashboard</a>
      <span class="muted" id="api-used"></span>
    </div>
  </div>

  <script>
    const API_BASE = localStorage.getItem('API_BASE') || 'https://damiano-backend-ancz.onrender.com';
    document.getElementById('api-used').textContent = `API: ${API_BASE}`;

    const q = sel => document.querySelector(sel);
    const show = el => (typeof el === 'string' ? q(el) : el).classList.remove('hidden');
    const hide = el => (typeof el === 'string' ? q(el) : el).classList.add('hidden');

    // Carica i valori attivi
    async function loadSettings(){
      const res = await fetch(`${API_BASE}/api/email/settings`);
      const data = await res.json();
      q('#subject').value = data.subject || '';
      q('#body').value = data.body || '';
    }

    // Carica i modelli salvati
    async function loadTemplates(type, containerSel){
      const res = await fetch(`${API_BASE}/api/email/templates?type=${type}`);
      const list = await res.json();
      const box = q(containerSel);
      box.innerHTML = '';
      if(!list.length){ box.innerHTML = '<div class="item muted">Nessun modello salvato</div>'; return; }
      list.forEach(t=>{
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<b>${t.name}</b> <span class="badge">${type}</span><div class="muted">${(t.content||'').slice(0,120)}</div>`;
        div.onclick = async () => {
          if(type==='subject'){ q('#subject').value = t.content; await saveSettings({subject:t.content, subject_template_id:t.id}); }
          else { q('#body').value = t.content; await saveSettings({body:t.content, body_template_id:t.id}); }
          hide(containerSel); hide(`#${type}-ask1`);
        };
        box.appendChild(div);
      });
    }

    // Salva i valori attivi
    async function saveSettings(payload){
      await fetch(`${API_BASE}/api/email/settings`, {
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
    }

    // Salva un modello
    async function saveTemplate(type, name, content){
      const res = await fetch(`${API_BASE}/api/email/templates`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({type, name, content})
      });
      return res.json();
    }

    // Subject
    q('#btn-change-subject').onclick = ()=>{ show('#subject-ask1'); };
    q('#subject-ask1 [data-yes]').onclick = ()=>{ loadTemplates('subject', '#subject-list'); show('#subject-list'); };
    q('#subject-ask1 [data-no]').onclick = ()=>{ hide('#subject-ask1'); show('#subject-ask2'); };
    q('#subject-ask2 [data-edit]').onclick = ()=>{ hide('#subject-ask2'); q('#subject').disabled=false; show('#subject-save-ask'); };
    q('[data-save="subject"]').onclick = ()=>{ hide('#subject-save-ask'); show('#subject-save-name'); };
    q('[data-nosave="subject"]').onclick = async ()=>{ hide('#subject-save-ask'); q('#subject').disabled=true; await saveSettings({subject:q('#subject').value, subject_template_id:null}); };
    q('#subject-confirm').onclick = async ()=>{
      const name = q('#subject-model-name').value.trim();
      if(!name) return alert('Inserisci un nome');
      const content = q('#subject').value;
      const t = await saveTemplate('subject', name, content);
      await saveSettings({subject:content, subject_template_id:t.id});
      q('#subject').disabled=true; hide('#subject-save-name');
      alert('Salvato');
    };
    
<div class="actions hidden" id="subject-use-ask">
  <span>Vuoi usare questo testo per le mail?</span>
  <button class="btn" id="subject-use-yes">SI</button>
  <button class="btn" id="subject-use-no">NO</button>
</div>
    
    // Body
    q('#btn-change-body').onclick = ()=>{ show('#body-ask1'); };
    q('#body-ask1 [data-yes]').onclick = ()=>{ loadTemplates('body', '#body-list'); show('#body-list'); };
    q('#body-ask1 [data-no]').onclick = ()=>{ hide('#body-ask1'); show('#body-ask2'); };
    q('#body-ask2 [data-edit]').onclick = ()=>{ hide('#body-ask2'); q('#body').disabled=false; show('#body-save-ask'); };
    q('[data-save="body"]').onclick = ()=>{ hide('#body-save-ask'); show('#body-save-name'); };
    q('[data-nosave="body"]').onclick = async ()=>{ hide('#body-save-ask'); q('#body').disabled=true; await saveSettings({body:q('#body').value, body_template_id:null}); };
    q('#body-confirm').onclick = async ()=>{
      const name = q('#body-model-name').value.trim();
      if(!name) return alert('Inserisci un nome');
      const content = q('#body').value;
      const t = await saveTemplate('body', name, content);
      await saveSettings({body:content, body_template_id:t.id});
      q('#body').disabled=true; hide('#body-save-name');
      alert('Salvato');
    };
    
  <div class="actions hidden" id="body-use-ask">
  <span>Vuoi usare questo testo per le mail?</span>
  <button class="btn" id="body-use-yes">SI</button>
  <button class="btn" id="body-use-no">NO</button>
  </div>
    
    // Chiudi azioni se clicchi NO
    document.querySelectorAll('[data-cancel]').forEach(btn=>{
      btn.onclick = ()=>{ document.querySelectorAll('.actions,.list,.row').forEach(el=>el.classList.add('hidden')); };
    });

    loadSettings();
  </script>
  const API_BASE = localStorage.getItem('API_BASE') || 'https://damiano-backend-ancz.onrender.com';
document.getElementById('api-used').textContent = `API: ${API_BASE}`;

const q = sel => document.querySelector(sel);
const show = el => (typeof el === 'string' ? q(el) : el).classList.remove('hidden');
const hide = el => (typeof el === 'string' ? q(el) : el).classList.add('hidden');

// üîπ valori iniziali all'apertura
let initialSubject = '';
let initialBody = '';
// üîπ temporanei scelti dalla lista
let pickedSubject = { id: null, content: '' };
let pickedBody = { id: null, content: '' };

// Carica ATTIVI
async function loadSettings(){
  const res = await fetch(`${API_BASE}/api/email/settings`);
  const data = await res.json();
  q('#subject').value = initialSubject = data.subject || '';
  q('#body').value    = initialBody    = data.body || '';
}

// Lista modelli
async function loadTemplates(type, containerSel){
  const res = await fetch(`${API_BASE}/api/email/templates?type=${type}`);
  const list = await res.json();
  const box = q(containerSel);
  box.innerHTML = '';
  if(!list.length){ box.innerHTML = '<div class="item muted">Nessun modello salvato</div>'; return; }

  list.forEach(t=>{
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<b>${t.name}</b> <span class="badge">${type}</span><div class="muted">${(t.content||'').slice(0,160)}</div>`;
    div.onclick = () => {
      // memorizza il modello selezionato e mostra "Usare questo testo?"
      if(type==='subject'){
        pickedSubject = { id: t.id, content: t.content };
        show('#subject-use-ask');
      } else {
        pickedBody = { id: t.id, content: t.content };
        show('#body-use-ask');
      }
    };
    box.appendChild(div);
  });
}

// Salva ATTIVI
async function saveSettings(payload){
  await fetch(`${API_BASE}/api/email/settings`, {
    method:'PUT', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
}

// Salva modello
async function saveTemplate(type, name, content){
  const res = await fetch(`${API_BASE}/api/email/templates`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({type, name, content})
  });
  return res.json();
}

/* ===== SUBJECT ===== */
q('#btn-change-subject').onclick = () => {
  hide('#subject-ask2'); hide('#subject-list'); hide('#subject-save-ask'); hide('#subject-save-name'); hide('#subject-use-ask');
  show('#subject-ask1');
};
// SI ‚Üí mostra direttamente la lista
q('#subject-ask1 [data-yes]').onclick = () => { hide('#subject-ask1'); loadTemplates('subject', '#subject-list'); show('#subject-list'); };
// NO ‚Üí ‚ÄúVuoi modificare‚Ä¶?‚Äù
q('#subject-ask1 [data-no]').onclick  = () => { hide('#subject-ask1'); show('#subject-ask2'); };

// ‚ñ∫ Dopo scelta dalla lista: "Usare questo testo?"
q('#subject-use-yes').onclick = async () => {
  // usa il testo selezionato
  q('#subject').value = pickedSubject.content;
  await saveSettings({ subject: pickedSubject.content, subject_template_id: pickedSubject.id });
  // pulizia UI
  hide('#subject-use-ask'); hide('#subject-list');
  alert('Impostato come testo attivo.');
};

q('#subject-use-no').onclick = () => {
  // non usarlo ‚Üí chiedi se vuoi modificare questo testo
  hide('#subject-use-ask');
  show('#subject-ask2');
};

q('#subject-ask2 [data-edit]').onclick = () => {
  // abilita modifica (parte dal valore corrente nel campo)
  q('#subject').disabled = false;
  hide('#subject-ask2');
  show('#subject-save-ask');
};

// Salvataggio SI/NO dalla modifica manuale
q('[data-save="subject"]').onclick = () => { hide('#subject-save-ask'); show('#subject-save-name'); };
q('[data-nosave="subject"]').onclick = async () => {
  // NO: ripristina il testo di apertura pagina
  q('#subject').value   = initialSubject;
  q('#subject').disabled = true;
  await saveSettings({ subject: initialSubject, subject_template_id: null });
  hide('#subject-save-ask'); hide('#subject-ask2');
};

q('#subject-confirm').onclick = async () => {
  const name = q('#subject-model-name').value.trim();
  if(!name) return alert('Inserisci un nome');
  const content = q('#subject').value;
  const t = await saveTemplate('subject', name, content);
  await saveSettings({ subject: content, subject_template_id: t.id });
  q('#subject').disabled = true; hide('#subject-save-name');
  alert('Salvato e impostato come attivo.');
};

/* ===== BODY ===== */
q('#btn-change-body').onclick = () => {
  hide('#body-ask2'); hide('#body-list'); hide('#body-save-ask'); hide('#body-save-name'); hide('#body-use-ask');
  show('#body-ask1');
};

q('#body-ask1 [data-yes]').onclick = () => { hide('#body-ask1'); loadTemplates('body', '#body-list'); show('#body-list'); };
q('#body-ask1 [data-no]').onclick  = () => { hide('#body-ask1'); show('#body-ask2'); };

q('#body-use-yes').onclick = async () => {
  q('#body').value = pickedBody.content;
  await saveSettings({ body: pickedBody.content, body_template_id: pickedBody.id });
  hide('#body-use-ask'); hide('#body-list');
  alert('Impostato come testo attivo.');
};

q('#body-use-no').onclick = () => {
  hide('#body-use-ask');
  show('#body-ask2');
};

q('#body-ask2 [data-edit]').onclick = () => {
  q('#body').disabled = false;
  hide('#body-ask2');
  show('#body-save-ask');
};

q('[data-save="body"]').onclick = () => { hide('#body-save-ask'); show('#body-save-name'); };
q('[data-nosave="body"]').onclick = async () => {
  q('#body').value    = initialBody;
  q('#body').disabled = true;
  await saveSettings({ body: initialBody, body_template_id: null });
  hide('#body-save-ask'); hide('#body-ask2');
};

q('#body-confirm').onclick = async () => {
  const name = q('#body-model-name').value.trim();
  if(!name) return alert('Inserisci un nome');
  const content = q('#body').value;
  const t = await saveTemplate('body', name, content);
  await saveSettings({ body: content, body_template_id: t.id });
  q('#body').disabled = true; hide('#body-save-name');
  alert('Salvato e impostato come attivo.');
};

// Chiudi/annulla generico (NO dei primi prompt)
document.querySelectorAll('[data-cancel]').forEach(btn=>{
  btn.onclick = () => {
    ['#subject-ask1','#subject-ask2','#subject-list','#subject-use-ask','#subject-save-ask','#subject-save-name',
     '#body-ask1','#body-ask2','#body-list','#body-use-ask','#body-save-ask','#body-save-name'
    ].forEach(hide);
    // ripristina i valori di apertura
    q('#subject').value = initialSubject;
    q('#body').value = initialBody;
    q('#subject').disabled = true;
    q('#body').disabled = true;
  };
});

loadSettings();

   </script>
</body>
</html>
