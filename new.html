<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nuovo Inserimento â€“ Damiano</title>
  <style>
    body{margin:0;background:#f3f4f6;font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
    .container{max-width:700px;margin:20px auto;background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 10px rgba(0,0,0,.08)}
    h1{margin:0 0 8px} p.muted{margin:0 0 16px;color:#6b7280}
    label{display:block;font-size:13px;color:#374151;margin-top:12px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;margin-top:4px}
    textarea{min-height:100px;resize:vertical}
    .row{display:flex;gap:8px;margin-top:4px}
    .btn{padding:10px 14px;border-radius:8px;cursor:pointer;border:1px solid #d1d5db;background:#fff}
    .btn-primary{background:#2563eb;color:#fff;border:none}
    .status{margin-top:14px;min-height:22px;font-size:14px}
    .ok{color:#065f46}.bad{color:#b91c1c}
    .err{font-size:12px;color:#b91c1c;display:none}
  </style>
</head>
<body>
  <div class="container">
    <h1>Nuovo Inserimento</h1>
    <p class="muted">Compila i campi. Nome e Cognome sono obbligatori.</p>

    <form id="formNew" novalidate>
      <!-- Dati cliente -->
      <label>Nome *</label>
      <input id="nome" required />
      <div id="err-nome" class="err">Inserisci il nome</div>

      <label>Cognome *</label>
      <input id="cognome" required />
      <div id="err-cognome" class="err">Inserisci il cognome</div>

      <label>Telefono</label>
      <div class="row">
        <select id="prefisso" style="max-width:150px">
          <option value="+39" selected>ğŸ‡®ğŸ‡¹ +39 Italia</option>
          <option value="+33">ğŸ‡«ğŸ‡· +33 Francia</option>
          <option value="+49">ğŸ‡©ğŸ‡ª +49 Germania</option>
          <option value="+44">ğŸ‡¬ğŸ‡§ +44 UK</option>
          <option value="+1">ğŸ‡ºğŸ‡¸ +1 USA</option>
        </select>
        <input id="telefono" placeholder="Numero" inputmode="tel"/>
      </div>

      <label>Email</label>
      <input id="email" type="email" placeholder="nome@dominio.it"/>
      <div id="err-email" class="err">Inserisci un indirizzo email valido</div>

      <!-- Dati defunto -->
      <label>Nome Defunto</label>
      <input id="def_nome" />

      <label>Cognome Defunto</label>
      <input id="def_cognome" />

      <label>Data Decesso (Ricorrenza)</label>
      <input id="def_data" type="date" />

      <!-- Invio mail -->
      <label>Giorni prima dellâ€™invio</label>
      <input id="giorni_prima" type="number" min="0" placeholder="solo numeri"/>
      <div id="err-giorni" class="err">Inserisci solo numeri >= 0</div>

      <label>Oggetto della mail</label>
      <div class="row">
        <input id="oggetto" value="In memoria di {{NOME}} {{COGNOME}}" readonly />
        <button type="button" id="btnOggetto" class="btn">Cambia</button>
      </div>

      <label>Corpo del messaggio</label>
      <div class="row">
        <textarea id="corpo" readonly>Gentile {{NOME}} {{COGNOME}},&#10;ti ricordiamo con affetto in questa ricorrenza.&#10;â€”</textarea>
        <button type="button" id="btnCorpo" class="btn">Cambia</button>
      </div>

      <!-- Bottoni -->
      <div class="row" style="margin-top:16px">
        <button class="btn btn-primary" type="submit">ğŸ’¾ Salva</button>
        <button class="btn" type="button" id="btnHome">ğŸ  Home</button>
      </div>
      <p id="status" class="status"></p>
    </form>
  </div>

  <script>
    const API = "https://damiano-backend-ancz.onrender.com"; // aggiorna con il tuo backend

    // Oggetto editabile/readonly
    function toggleEditable(id, btnId){
      const input = document.getElementById(id);
      const btn = document.getElementById(btnId);
      if(input.readOnly){
        input.readOnly = false; btn.textContent="Salva";
      } else {
        input.readOnly = true; btn.textContent="Cambia";
      }
    }
    document.getElementById("btnOggetto").onclick=()=>toggleEditable("oggetto","btnOggetto");
    document.getElementById("btnCorpo").onclick=()=>toggleEditable("corpo","btnCorpo");

    document.getElementById("btnHome").onclick=()=>location.href="home.html";

    const form=document.getElementById("formNew");
    form.onsubmit=async e=>{
      e.preventDefault();
      document.getElementById("status").textContent="â³ Salvataggioâ€¦";

      const rec={
        nome: nome.value.trim(),
        cognome: cognome.value.trim(),
        telefono_prefisso: prefisso.value,
        telefono_numero: telefono.value.trim(),
        email: email.value.trim(),
        def_nome: def_nome.value.trim(),
        def_cognome: def_cognome.value.trim(),
        def_data: def_data.value,
        giorni_prima: parseInt(giorni_prima.value||"0"),
        oggetto: oggetto.value.trim(),
        corpo: corpo.value.trim()
      };

      try{
        let res=await fetch(API+"/records",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(rec)});
        if(res.status===201||res.status===200){
          document.getElementById("status").textContent="âœ… Salvato con successo";
          form.reset();
          return;
        }
        if(res.status===409){
          if(confirm("Contatto duplicato. Vuoi sovrascrivere?")){
            const data=await res.json();
            const id=data?.id; // se backend manda id, lo usiamo
            if(id){
              let put=await fetch(API+"/records/"+id,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(rec)});
              if(put.ok){
                document.getElementById("status").textContent="âœ… Sovrascritto con successo";
                form.reset();
                return;
              }
            }
          }
          document.getElementById("status").textContent="âŒ Contatto non salvato";
          return;
        }
        throw new Error(await res.text());
      }catch(err){
        document.getElementById("status").textContent="âŒ Errore: "+err.message;
      }
    };
  </script>
</body>
</html>

