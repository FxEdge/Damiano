<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dettagli contatto</title>
  <link rel="icon" href="assets/logo.svg">
  <style>
    :root{--bg:#f3f4f6;--surface:#fff;--text:#111827;--muted:#6b7280;--border:#e5e7eb;--primary:#2563eb}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{width:min(1100px,92%);margin-inline:auto;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:16px}
    h1{margin:0 0 8px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;font-weight:600;margin:8px 0 6px}
    input[type="text"], input[type="date"], input[type="number"], textarea{
      width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;font:inherit;background:#fff
    }
    textarea{min-height:140px;resize:vertical;white-space:pre-wrap}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;border:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Dettagli contatto</h1>
      <button id="btnBack" class="btn">‚Üê Torna indietro</button>
    </header>

    <section class="card">
      <form id="form" class="grid">
        <input type="hidden" id="rid">

        <div>
          <label>Nome</label>
          <input type="text" id="nome">
        </div>
        <div>
          <label>Cognome</label>
          <input type="text" id="cognome">
        </div>

        <div>
          <label>Email</label>
          <input type="text" id="email">
        </div>
        <div>
          <label>Telefono (prefisso)</label>
          <input type="text" id="prefisso" value="+39">
        </div>

        <div>
          <label>Telefono (numero)</label>
          <input type="text" id="telefono">
        </div>
        <div>
          <label>Giorni prima (promemoria)</label>
          <input type="number" id="giorni" min="0">
        </div>

        <div>
          <label>Defunto ‚Äì Nome</label>
          <input type="text" id="def_nome">
        </div>
        <div>
          <label>Defunto ‚Äì Cognome</label>
          <input type="text" id="def_cognome">
        </div>

        <div>
          <label>Defunto ‚Äì Data (YYYY-MM-DD)</label>
          <input type="date" id="def_data">
        </div>
        <div class="form-group">
          <label for="prossima_ricorrenza">Prossima ricorrenza</label>
          <input type="date" id="prossima_ricorrenza" name="prossima_ricorrenza" readonly />
        </div>
        <div>
          <label>Oggetto email</label>
          <input type="text" id="oggetto">
        </div>

        <div style="grid-column:1 / -1">
          <label>Corpo email</label>
          <textarea id="corpo"></textarea>
        </div>

        <div class="actions" style="grid-column:1 / -1">
          <button type="button" id="btnExit" class="btn">Esci</button>
          <button type="submit" class="btn btn-primary">üíæ Salva</button>
        </div>
      </form>
    </section>

    <p class="muted" style="margin-top:10px">API: <code id="apiInUso"></code></p>
  </div>

  <script>
document.addEventListener('DOMContentLoaded', () => {
  // ===== Guard auth =====
  if (!localStorage.getItem('damiano_token')) { location.replace('index.html'); return; }

  // ===== API base =====
  const DEFAULT_API = 'https://damiano-backend-ancz.onrender.com';
  const API = localStorage.getItem('damiano_api') || DEFAULT_API;
  const apiEl = document.getElementById('apiInUso');
  if (apiEl) apiEl.textContent = API;

  // ===== Helpers =====
  const $ = s => document.querySelector(s);
  const params = new URLSearchParams(location.search);
  const rid   = params.get('id');
  const from  = params.get('from'); // "search" se arrivi dalla tabella

  function goBack() {
    // Se arrivo da una pagina del TUO sito, uso history.back per mantenere il filtro ricerca
    try {
      const ref = document.referrer ? new URL(document.referrer) : null;
      if (ref && ref.origin === location.origin) {
        history.back();
        return;
      }
    } catch (_) {}
    // Fallback coerente
    if (from === 'search') location.href = '/ricerca.html?mode=edit';
    else location.href = '/home.html';
  }

  function setDisabled(disabled) {
    document.querySelectorAll('#form input, #form textarea, #form button')
      .forEach(el => el.disabled = disabled);
  }

  async function loadRecord() {
    if (!rid) {
      alert('ID mancante nell‚ÄôURL. Torno alla pagina precedente.');
      goBack();
      return;
    }
    try {
      setDisabled(true);
      const url = `${API}/records/${encodeURIComponent(rid)}`;
      console.log('[GET]', url);
      const res = await fetch(url);
      if (!res.ok) {
        const txt = await res.text().catch(()=> '');
        alert(`Errore nel caricamento (HTTP ${res.status}).\n${txt.slice(0,200)}`);
        goBack();
        return;
      }
      const r = await res.json();

      $('#rid').value          = r.id;
      $('#nome').value         = r.nome || '';
      $('#cognome').value      = r.cognome || '';
      $('#email').value        = r.email || '';
      $('#prefisso').value     = r.telefono_prefisso || '+39';
      $('#telefono').value     = r.telefono_numero || '';
      $('#giorni').value       = (r.giorni_prima ?? '') === null ? '' : (r.giorni_prima ?? '');
      $('#def_nome').value     = r.def_nome || '';
      $('#def_cognome').value  = r.def_cognome || '';
      $('#def_data').value     = r.def_data || '';
      $('#oggetto').value      = r.oggetto || '';
      $('#corpo').value        = r.corpo || '';
    } catch (e) {
      alert('Errore di rete nel caricamento del contatto.');
      goBack();
    } finally {
      setDisabled(false);
    }
  }

  // === Handlers bottoni ===
  const btnBack = document.getElementById('btnBack');
  if (btnBack) btnBack.onclick = goBack;

  const btnExit = document.getElementById('btnExit');
  if (btnExit) btnExit.onclick = () => {
    if (confirm('Vuoi uscire senza salvare?')) goBack();
  };

  // === Salva con conferme ===
  const form = document.getElementById('form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!confirm('Vuoi sovrascrivere i dati?')) {
      if (confirm('Vuoi uscire senza salvare?')) goBack();
      return;
    }

    const payload = {
      id: $('#rid').value,
      nome: $('#nome').value.trim(),
      cognome: $('#cognome').value.trim(),
      email: $('#email').value.trim() || null,
      telefono_prefisso: $('#prefisso').value.trim() || '+39',
      telefono_numero: $('#telefono').value.trim() || null,
      giorni_prima: $('#giorni').value ? Number($('#giorni').value) : null,
      def_nome: $('#def_nome').value.trim() || null,
      def_cognome: $('#def_cognome').value.trim() || null,
      def_data: $('#def_data').value || null,
      oggetto: $('#oggetto').value || null,
      corpo: $('#corpo').value || null,
    };

    try {
      setDisabled(true);
      const url = `${API}/records/${encodeURIComponent(rid)}`;
      console.log('[PUT]', url, payload);
      const res = await fetch(url, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const err = await res.json().catch(()=>({}));
        alert('Errore salvataggio: ' + (err.detail || res.status));
        setDisabled(false);
        return;
      }
      alert('Dati aggiornati ‚úÖ');
      goBack();
    } catch (e) {
      alert('Errore di rete durante il salvataggio');
      setDisabled(false);
    }
  });

  // Avvio
  loadRecord();
});
</script>
